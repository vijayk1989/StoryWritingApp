import{s as d}from"./supabase.YDNJ6__1.js";import{m as I,u as b}from"./index.Bk4Tk5ow.js";import{c as u}from"./react.BoqmBW-A.js";class k{dbName;version;constructor(t,o=1){this.dbName=t,this.version=o}async openDB(){return new Promise((t,o)=>{const e=indexedDB.open(this.dbName,this.version);e.onerror=()=>o(e.error),e.onsuccess=()=>t(e.result),e.onupgradeneeded=r=>{const s=r.target.result;s.objectStoreNames.contains("lorebookItems")||s.createObjectStore("lorebookItems")}})}async getItems(t){const o=await this.openDB();return new Promise((e,r)=>{const s=o.transaction("lorebookItems","readonly"),c=s.objectStore("lorebookItems").get(t);c.onerror=()=>r(c.error),c.onsuccess=()=>e(c.result||[]),s.oncomplete=()=>o.close()})}async setItems(t,o){const e=await this.openDB();return new Promise((r,s)=>{const a=e.transaction("lorebookItems","readwrite"),i=a.objectStore("lorebookItems").put(o,t);i.onerror=()=>s(i.error),i.onsuccess=()=>r(),a.oncomplete=()=>e.close()})}async clearItems(t){const o=await this.openDB();return new Promise((e,r)=>{const s=o.transaction("lorebookItems","readwrite"),c=s.objectStore("lorebookItems").delete(t);c.onerror=()=>r(c.error),c.onsuccess=()=>e(),s.oncomplete=()=>o.close()})}async clearAll(){const t=await this.openDB();return new Promise((o,e)=>{const r=t.transaction("lorebookItems","readwrite"),a=r.objectStore("lorebookItems").clear();a.onerror=()=>e(a.error),a.onsuccess=()=>o(),r.oncomplete=()=>t.close()})}}const l=new k("lorebook-store"),y=async n=>{const{data:t,error:o}=await d.from("lorebook_items").select("*").eq("lorebook_id",n).order("created_at",{ascending:!0});if(o)throw o;return t},f=n=>{const{name:t,tags:o,classification:e,lore_type:r,description:s}=n;return{name:t,tags:o,classification:e,lore_type:r,description:s}},m=n=>{const t={};return n.forEach(o=>{const e=f(o),r=o.name.toLowerCase().trim();if(t[r]=e,o.tags){let s=[];typeof o.tags=="string"?s=o.tags.split(",").map(a=>a.trim()):Array.isArray(o.tags)&&(s=o.tags),s.forEach(a=>{const c=a.toLowerCase().trim();t[c]=e})}}),t},w=u((n,t)=>({currentStoryId:null,lorebookItems:[],lorebookItemsByTag:{},isCreating:!1,error:null,setCurrentStory:async o=>{if(o!==t().currentStoryId){if(n({lorebookItems:[],lorebookItemsByTag:{}}),o)try{const e=await l.getItems(o);if(e?.length>0){n({currentStoryId:o,lorebookItems:e,lorebookItemsByTag:m(e)});return}}catch(e){console.error("Error loading from IndexedDB:",e)}else try{await l.clearAll()}catch(e){console.error("Error clearing IndexedDB:",e)}n({currentStoryId:o})}},setLorebookItems:async o=>{n({lorebookItems:o,lorebookItemsByTag:m(o)});const e=t().currentStoryId;if(e)try{await l.setItems(e,o)}catch(r){console.error("Error caching to IndexedDB:",r)}},createLorebookItem:async o=>{n({isCreating:!0});try{const{data:e,error:r}=await d.from("lorebook_items").insert([o]).select().single();if(r)throw r;const s=[...t().lorebookItems,e];n({lorebookItems:s,lorebookItemsByTag:m(s)});const a=t().currentStoryId;a&&await l.setItems(a,s),await I(`lorebook-items/${o.lorebook_id}`)}catch(e){throw n({error:e.message}),e}finally{n({isCreating:!1})}},updateLorebookItem:async(o,e)=>{try{const{data:r,error:s}=await d.from("lorebook_items").update(e).eq("id",o).select().single();if(s)throw s;const a=t().lorebookItems.map(i=>i.id===o?{...i,...r}:i);n({lorebookItems:a,lorebookItemsByTag:m(a)});const c=t().currentStoryId;c&&await l.setItems(c,a),await I(`lorebook-items/${e.lorebook_id}`)}catch(r){throw n({error:r.message}),r}},deleteLorebookItem:async(o,e)=>{try{const{error:r}=await d.from("lorebook_items").delete().eq("id",o);if(r)throw r;const s=t().lorebookItems.filter(c=>c.id!==o);n({lorebookItems:s,lorebookItemsByTag:m(s)});const a=t().currentStoryId;a&&await l.setItems(a,s),await I(`lorebook-items/${e}`)}catch(r){throw n({error:r.message}),r}},findItemByTag:o=>{const e=o.toLowerCase().trim();return t().lorebookItemsByTag[e]}})),B=n=>{const{currentStoryId:t,lorebookItems:o,setLorebookItems:e}=w();return b(n?`lorebook-items/${n}`:null,async()=>{if(o.length>0&&t)return o;if(t)try{const r=await l.getItems(t);if(r?.length>0)return e(r),r}catch(r){console.error("Error loading from IndexedDB:",r)}if(n){const r=await y(n);return e(r),r}return[]},{revalidateOnFocus:!1,revalidateOnReconnect:!1})};export{B as a,w as u};
