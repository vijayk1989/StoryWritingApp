import{z as T}from"./Editor.CJH2FCh-.js";import{p as E,e as b,l as R,d as S,s as z,t as M,c as $,b as j,a as q,i as G}from"./list-item.C6BHWQ3y.js";import{v as Q}from"./index.Bh53YJoR.js";import{E as D,c as U}from"./index.D8ScSV_8.js";import{t as x}from"./index.C_aolqmU.js";import"./jsx-runtime.B-tYHWOS.js";import"./index.BCPtUIm2.js";import"./supabase.YDNJ6__1.js";import"./floating-ui.react-dom.BmbJoTtk.js";import"./index.D1eIsul2.js";import"./button.DSwAMVRZ.js";import"./index.BuzRTTe3.js";import"./iconBase.wJcibKWI.js";import"./useLorebookStore.GsEaYorD.js";import"./index.Bk4Tk5ow.js";import"./react.BoqmBW-A.js";import"./useChapterStore.BIfqi0n6.js";import"./index.BInd9SeV.js";import"./index.D7TIu75F.js";function m(r,t){let e=-1,n;if(t.extensions)for(;++e<t.extensions.length;)m(r,t.extensions[e]);for(n in t)n==="extensions"||(n==="unsafe"||n==="join"?r[n]=[...r[n]||[],...t[n]||[]]:n==="handlers"?r[n]=Object.assign(r[n],t[n]||{}):r.options[n]=t[n]);return r}function Z(r,t,e,n){const u=e.enter("blockquote"),l=e.createTracker(n);l.move("> "),l.shift(2);const i=e.indentLines(e.containerFlow(r,l.current()),H);return u(),i}function H(r,t,e){return">"+(e?"":" ")+r}function g(r,t,e,n){let u=-1;for(;++u<e.unsafe.length;)if(e.unsafe[u].character===`
`&&E(e.stack,e.unsafe[u]))return/[ \t]/.test(n.before)?"":" ";return`\\
`}function W(r,t){const e=String(r);let n=e.indexOf(t),u=n,l=0,i=0;if(typeof t!="string")throw new TypeError("Expected substring");for(;n!==-1;)n===u?++l>i&&(i=l):l=1,u=n+t.length,n=e.indexOf(t,u);return i}function k(r,t){return!!(!t.options.fences&&r.value&&!r.lang&&/[^ \r\n]/.test(r.value)&&!/^[\t ]*(?:[\r\n]|$)|(?:^|[\r\n])[\t ]*$/.test(r.value))}function X(r){const t=r.options.fence||"`";if(t!=="`"&&t!=="~")throw new Error("Cannot serialize code with `"+t+"` for `options.fence`, expected `` ` `` or `~`");return t}function J(r,t,e,n){const u=X(e),l=r.value||"",i=u==="`"?"GraveAccent":"Tilde";if(k(r,e)){const s=e.enter("codeIndented"),h=e.indentLines(l,K);return s(),h}const a=e.createTracker(n),c=u.repeat(Math.max(W(l,u)+1,3)),o=e.enter("codeFenced");let f=a.move(c);if(r.lang){const s=e.enter(`codeFencedLang${i}`);f+=a.move(e.safe(r.lang,{before:f,after:" ",encode:["`"],...a.current()})),s()}if(r.lang&&r.meta){const s=e.enter(`codeFencedMeta${i}`);f+=a.move(" "),f+=a.move(e.safe(r.meta,{before:f,after:`
`,encode:["`"],...a.current()})),s()}return f+=a.move(`
`),l&&(f+=a.move(l+`
`)),f+=a.move(c),o(),f}function K(r,t,e){return(e?"":"    ")+r}function v(r){const t=r.options.quote||'"';if(t!=='"'&&t!=="'")throw new Error("Cannot serialize title with `"+t+"` for `options.quote`, expected `\"`, or `'`");return t}function N(r,t,e,n){const u=v(e),l=u==='"'?"Quote":"Apostrophe",i=e.enter("definition");let a=e.enter("label");const c=e.createTracker(n);let o=c.move("[");return o+=c.move(e.safe(e.associationId(r),{before:o,after:"]",...c.current()})),o+=c.move("]: "),a(),!r.url||/[\0- \u007F]/.test(r.url)?(a=e.enter("destinationLiteral"),o+=c.move("<"),o+=c.move(e.safe(r.url,{before:o,after:">",...c.current()})),o+=c.move(">")):(a=e.enter("destinationRaw"),o+=c.move(e.safe(r.url,{before:o,after:r.title?" ":`
`,...c.current()}))),a(),r.title&&(a=e.enter(`title${l}`),o+=c.move(" "+u),o+=c.move(e.safe(r.title,{before:o,after:u,...c.current()})),o+=c.move(u),a()),i(),o}function V(r){const t=r.options.emphasis||"*";if(t!=="*"&&t!=="_")throw new Error("Cannot serialize emphasis with `"+t+"` for `options.emphasis`, expected `*`, or `_`");return t}w.peek=Y;function w(r,t,e,n){const u=V(e),l=e.enter("emphasis"),i=e.createTracker(n);let a=i.move(u);return a+=i.move(e.containerPhrasing(r,{before:a,after:u,...i.current()})),a+=i.move(u),l(),a}function Y(r,t,e){return e.options.emphasis||"*"}function C(r,t){let e=!1;return Q(r,n=>{if("value"in n&&/\r?\n|\r/.test(n.value)||n.type==="break")return e=!0,D}),!!((!r.depth||r.depth<3)&&x(r)&&(t.options.setext||e))}function ee(r,t,e,n){const u=Math.max(Math.min(6,r.depth||1),1),l=e.createTracker(n);if(C(r,e)){const f=e.enter("headingSetext"),s=e.enter("phrasing"),h=e.containerPhrasing(r,{...l.current(),before:`
`,after:`
`});return s(),f(),h+`
`+(u===1?"=":"-").repeat(h.length-(Math.max(h.lastIndexOf("\r"),h.lastIndexOf(`
`))+1))}const i="#".repeat(u),a=e.enter("headingAtx"),c=e.enter("phrasing");l.move(i+" ");let o=e.containerPhrasing(r,{before:"# ",after:`
`,...l.current()});return/^[\t ]/.test(o)&&(o="&#x"+o.charCodeAt(0).toString(16).toUpperCase()+";"+o.slice(1)),o=o?i+" "+o:i,e.options.closeAtx&&(o+=" "+i),c(),a(),o}O.peek=re;function O(r){return r.value||""}function re(){return"<"}_.peek=te;function _(r,t,e,n){const u=v(e),l=u==='"'?"Quote":"Apostrophe",i=e.enter("image");let a=e.enter("label");const c=e.createTracker(n);let o=c.move("![");return o+=c.move(e.safe(r.alt,{before:o,after:"]",...c.current()})),o+=c.move("]("),a(),!r.url&&r.title||/[\0- \u007F]/.test(r.url)?(a=e.enter("destinationLiteral"),o+=c.move("<"),o+=c.move(e.safe(r.url,{before:o,after:">",...c.current()})),o+=c.move(">")):(a=e.enter("destinationRaw"),o+=c.move(e.safe(r.url,{before:o,after:r.title?" ":")",...c.current()}))),a(),r.title&&(a=e.enter(`title${l}`),o+=c.move(" "+u),o+=c.move(e.safe(r.title,{before:o,after:u,...c.current()})),o+=c.move(u),a()),o+=c.move(")"),i(),o}function te(){return"!"}y.peek=ne;function y(r,t,e,n){const u=r.referenceType,l=e.enter("imageReference");let i=e.enter("label");const a=e.createTracker(n);let c=a.move("![");const o=e.safe(r.alt,{before:c,after:"]",...a.current()});c+=a.move(o+"]["),i();const f=e.stack;e.stack=[],i=e.enter("reference");const s=e.safe(e.associationId(r),{before:c,after:"]",...a.current()});return i(),e.stack=f,l(),u==="full"||!o||o!==s?c+=a.move(s+"]"):u==="shortcut"?c=c.slice(0,-1):c+=a.move("]"),c}function ne(){return"!"}function A(r,t){const e=x(r);return!!(!t.options.resourceLink&&r.url&&!r.title&&r.children&&r.children.length===1&&r.children[0].type==="text"&&(e===r.url||"mailto:"+e===r.url)&&/^[a-z][a-z+.-]+:/i.test(r.url)&&!/[\0- <>\u007F]/.test(r.url))}B.peek=oe;function B(r,t,e,n){const u=v(e),l=u==='"'?"Quote":"Apostrophe",i=e.createTracker(n);let a,c;if(A(r,e)){const f=e.stack;e.stack=[],a=e.enter("autolink");let s=i.move("<");return s+=i.move(e.containerPhrasing(r,{before:s,after:">",...i.current()})),s+=i.move(">"),a(),e.stack=f,s}a=e.enter("link"),c=e.enter("label");let o=i.move("[");return o+=i.move(e.containerPhrasing(r,{before:o,after:"](",...i.current()})),o+=i.move("]("),c(),!r.url&&r.title||/[\0- \u007F]/.test(r.url)?(c=e.enter("destinationLiteral"),o+=i.move("<"),o+=i.move(e.safe(r.url,{before:o,after:">",...i.current()})),o+=i.move(">")):(c=e.enter("destinationRaw"),o+=i.move(e.safe(r.url,{before:o,after:r.title?" ":")",...i.current()}))),c(),r.title&&(c=e.enter(`title${l}`),o+=i.move(" "+u),o+=i.move(e.safe(r.title,{before:o,after:u,...i.current()})),o+=i.move(u),c()),o+=i.move(")"),a(),o}function oe(r,t,e){return A(r,e)?"<":"["}F.peek=ie;function F(r,t,e,n){const u=r.referenceType,l=e.enter("linkReference");let i=e.enter("label");const a=e.createTracker(n);let c=a.move("[");const o=e.containerPhrasing(r,{before:c,after:"]",...a.current()});c+=a.move(o+"]["),i();const f=e.stack;e.stack=[],i=e.enter("reference");const s=e.safe(e.associationId(r),{before:c,after:"]",...a.current()});return i(),e.stack=f,l(),u==="full"||!o||o!==s?c+=a.move(s+"]"):u==="shortcut"?c=c.slice(0,-1):c+=a.move("]"),c}function ie(){return"["}function ce(r){const t=b(r),e=r.options.bulletOther;if(!e)return t==="*"?"-":"*";if(e!=="*"&&e!=="+"&&e!=="-")throw new Error("Cannot serialize items with `"+e+"` for `options.bulletOther`, expected `*`, `+`, or `-`");if(e===t)throw new Error("Expected `bullet` (`"+t+"`) and `bulletOther` (`"+e+"`) to be different");return e}function L(r){const t=r.options.bulletOrdered||".";if(t!=="."&&t!==")")throw new Error("Cannot serialize items with `"+t+"` for `options.bulletOrdered`, expected `.` or `)`");return t}function ae(r){const t=L(r),e=r.options.bulletOrderedOther;if(!e)return t==="."?")":".";if(e!=="."&&e!==")")throw new Error("Cannot serialize items with `"+e+"` for `options.bulletOrderedOther`, expected `*`, `+`, or `-`");if(e===t)throw new Error("Expected `bulletOrdered` (`"+t+"`) and `bulletOrderedOther` (`"+e+"`) to be different");return e}function I(r){const t=r.options.rule||"*";if(t!=="*"&&t!=="-"&&t!=="_")throw new Error("Cannot serialize rules with `"+t+"` for `options.rule`, expected `*`, `-`, or `_`");return t}function ue(r,t,e,n){const u=e.enter("list"),l=e.bulletCurrent;let i=r.ordered?L(e):b(e);const a=r.ordered?ae(e):ce(e),c=e.bulletLastUsed;let o=!1;if(t&&(r.ordered?e.options.bulletOrderedOther:e.options.bulletOther)&&c&&i===c&&(o=!0),!r.ordered){const s=r.children?r.children[0]:void 0;if((i==="*"||i==="-")&&s&&(!s.children||!s.children[0])&&e.stack[e.stack.length-1]==="list"&&e.stack[e.stack.length-2]==="listItem"&&e.stack[e.stack.length-3]==="list"&&e.stack[e.stack.length-4]==="listItem"&&e.indexStack[e.indexStack.length-1]===0&&e.indexStack[e.indexStack.length-2]===0&&e.indexStack[e.indexStack.length-3]===0&&(o=!0),I(e)===i&&s){let h=-1;for(;++h<r.children.length;){const d=r.children[h];if(d&&d.type==="listItem"&&d.children&&d.children[0]&&d.children[0].type==="thematicBreak"){o=!0;break}}}}o&&(i=a),e.bulletCurrent=i;const f=e.containerFlow(r,n);return e.bulletLastUsed=i,e.bulletCurrent=l,u(),f}function le(r,t,e,n){const u=e.enter("paragraph"),l=e.enter("phrasing"),i=e.containerPhrasing(r,n);return l(),u(),i}const se=U(["break","delete","emphasis","footnote","footnoteReference","image","imageReference","inlineCode","link","linkReference","strong","text"]);function fe(r,t,e,n){return(r.children.some(i=>se(i))?e.containerPhrasing:e.containerFlow).call(e,r,n)}function he(r){const t=r.options.strong||"*";if(t!=="*"&&t!=="_")throw new Error("Cannot serialize strong with `"+t+"` for `options.strong`, expected `*`, or `_`");return t}P.peek=pe;function P(r,t,e,n){const u=he(e),l=e.enter("strong"),i=e.createTracker(n);let a=i.move(u+u);return a+=i.move(e.containerPhrasing(r,{before:a,after:u,...i.current()})),a+=i.move(u+u),l(),a}function pe(r,t,e){return e.options.strong||"*"}function de(r,t,e,n){return e.safe(r.value,n)}function me(r){const t=r.options.ruleRepetition||3;if(t<3)throw new Error("Cannot serialize rules with repetition `"+t+"` for `options.ruleRepetition`, expected `3` or more");return t}function ke(r,t,e){const n=(I(e)+(e.options.ruleSpaces?" ":"")).repeat(me(e));return e.options.ruleSpaces?n.slice(0,-1):n}const ve={blockquote:Z,break:g,code:J,definition:N,emphasis:w,hardBreak:g,heading:ee,html:O,image:_,imageReference:y,inlineCode:S,link:B,linkReference:F,list:ue,listItem:R,paragraph:le,root:fe,strong:P,text:de,thematicBreak:ke},ge=[be];function be(r,t,e,n){if(t.type==="code"&&k(t,n)&&(r.type==="list"||r.type===t.type&&k(r,n))||r.type==="list"&&r.type===t.type&&!!r.ordered==!!t.ordered&&!(r.ordered?n.options.bulletOrderedOther:n.options.bulletOther))return!1;if("spread"in e&&typeof e.spread=="boolean")return r.type==="paragraph"&&(r.type===t.type||t.type==="definition"||t.type==="heading"&&C(t,n))?void 0:e.spread?1:0}const p=["autolink","destinationLiteral","destinationRaw","reference","titleQuote","titleApostrophe"],xe=[{character:"	",after:"[\\r\\n]",inConstruct:"phrasing"},{character:"	",before:"[\\r\\n]",inConstruct:"phrasing"},{character:"	",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde"]},{character:"\r",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde","codeFencedMetaGraveAccent","codeFencedMetaTilde","destinationLiteral","headingAtx"]},{character:`
`,inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde","codeFencedMetaGraveAccent","codeFencedMetaTilde","destinationLiteral","headingAtx"]},{character:" ",after:"[\\r\\n]",inConstruct:"phrasing"},{character:" ",before:"[\\r\\n]",inConstruct:"phrasing"},{character:" ",inConstruct:["codeFencedLangGraveAccent","codeFencedLangTilde"]},{character:"!",after:"\\[",inConstruct:"phrasing",notInConstruct:p},{character:'"',inConstruct:"titleQuote"},{atBreak:!0,character:"#"},{character:"#",inConstruct:"headingAtx",after:`(?:[\r
]|$)`},{character:"&",after:"[#A-Za-z]",inConstruct:"phrasing"},{character:"'",inConstruct:"titleApostrophe"},{character:"(",inConstruct:"destinationRaw"},{before:"\\]",character:"(",inConstruct:"phrasing",notInConstruct:p},{atBreak:!0,before:"\\d+",character:")"},{character:")",inConstruct:"destinationRaw"},{atBreak:!0,character:"*",after:`(?:[ 	\r
*])`},{character:"*",inConstruct:"phrasing",notInConstruct:p},{atBreak:!0,character:"+",after:`(?:[ 	\r
])`},{atBreak:!0,character:"-",after:`(?:[ 	\r
-])`},{atBreak:!0,before:"\\d+",character:".",after:`(?:[ 	\r
]|$)`},{atBreak:!0,character:"<",after:"[!/?A-Za-z]"},{character:"<",after:"[!/?A-Za-z]",inConstruct:"phrasing",notInConstruct:p},{character:"<",inConstruct:"destinationLiteral"},{atBreak:!0,character:"="},{atBreak:!0,character:">"},{character:">",inConstruct:"destinationLiteral"},{atBreak:!0,character:"["},{character:"[",inConstruct:"phrasing",notInConstruct:p},{character:"[",inConstruct:["label","reference"]},{character:"\\",after:"[\\r\\n]",inConstruct:"phrasing"},{character:"]",inConstruct:["label","reference"]},{atBreak:!0,character:"_"},{character:"_",inConstruct:"phrasing",notInConstruct:p},{atBreak:!0,character:"`"},{character:"`",inConstruct:["codeFencedLangGraveAccent","codeFencedMetaGraveAccent"]},{character:"`",inConstruct:"phrasing",notInConstruct:p},{atBreak:!0,character:"~"}];function we(r,t={}){const e={enter:u,indentLines:G,associationId:q,containerPhrasing:ye,containerFlow:Ae,createTracker:M,safe:Be,stack:[],unsafe:[],join:[],handlers:{},options:{},indexStack:[],handle:void 0};m(e,{unsafe:xe,join:ge,handlers:ve}),m(e,t),e.options.tightDefinitions&&m(e,{join:[_e]}),e.handle=T("type",{invalid:Ce,unknown:Oe,handlers:e.handlers});let n=e.handle(r,void 0,e,{before:`
`,after:`
`,now:{line:1,column:1},lineShift:0});return n&&n.charCodeAt(n.length-1)!==10&&n.charCodeAt(n.length-1)!==13&&(n+=`
`),n;function u(l){return e.stack.push(l),i;function i(){e.stack.pop()}}}function Ce(r){throw new Error("Cannot handle value `"+r+"`, expected node")}function Oe(r){throw new Error("Cannot handle unknown node `"+r.type+"`")}function _e(r,t){if(r.type==="definition"&&r.type===t.type)return 0}function ye(r,t){return j(r,this,t)}function Ae(r,t){return $(r,this,t)}function Be(r,t){return z(this,r,t)}function We(r){Object.assign(this,{Compiler:e=>{const n=this.data("settings");return we(e,Object.assign({},n,r,{extensions:this.data("toMarkdownExtensions")||[]}))}})}export{We as default};
