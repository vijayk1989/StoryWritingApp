---
import Layout from '../../../../layouts/Layout.astro';
import Editor from '../../../../components/Editor';
import SideNav from '../../../../components/SideNav';
import { supabase } from '../../../../lib/supabase';
import Toaster from '../../../../components/Toaster';

const { storyId, chapterId } = Astro.params;

// Fetch the chapter and story
const { data: chapter } = await supabase
  .from('chapters')
  .select('*, stories!inner(*)')
  .eq('id', chapterId)
  .eq('stories.id', storyId)
  .single();

if (!chapter) {
  return Astro.redirect(`/story/${storyId}`);
}
---

<Layout title={`${chapter.stories.title} - ${chapter.title}`}>
  <div class="flex min-h-screen">
    <SideNav client:load storyId={storyId} />
    <main class="flex-1 w-full lg:ml-[5%]">
      <div class="w-[90%] sm:max-w-4xl mx-auto lg:py-8 sm:px-4">
        <div class="mb-6">
          <a 
            href={`/story/${storyId}`}
            class="text-blue-600 hover:text-blue-700 text-sm"
          >
            ‚Üê Back to Chapters
          </a>
          <h1 class="text-2xl font-bold mt-2">{chapter.title}</h1>
          {chapter.summary && (
            <p class="text-gray-600 mt-2">{chapter.summary}</p>
          )}
        </div>
        <Editor client:only="react" chapterId={chapterId} />
      </div>
    </main>
  </div>
  <Toaster client:load />
</Layout>
